{"timestamp": 1745247938.823852, "stored_source_code": "import numpy as np\nimport pandas as pd\n# declare a list tasks whose products you want to use as inputs\nupstream = None\nproduct = None\nmin_rows_categories = None # minimo de objetos que devem conter essas categorias para ser desconsiderado\ndf_input_path = '../../dados/X_trainToronto.csv'\ndf_reg = pd.read_csv(df_input_path)\ndf_reg = df_reg[['business_id', 'categories']]\ndf_reg\n## Transformar categories em dummies\ndf_reg.categories = df_reg.categories.fillna('')\ndf_reg.categories = df_reg.categories.astype(str)\ndf_reg.categories = df_reg.categories.str.split(',')\ndf_reg.categories = df_reg.categories.apply(lambda x: [s.strip().lower() for s in x])\ndf_reg.categories\nfrom collections import defaultdict\n\nall_categories = defaultdict(int)\nfor c_list in df_reg.categories:\n    if type(c_list) is float:\n        c_list = []\n    for c in c_list:\n        all_categories[c.strip().lower()] = all_categories[c.strip().lower()] + 1\n\nbest_categories = pd.Series(all_categories)\nbest_categories = best_categories[best_categories > min_rows_categories]\nothers_categories = set(all_categories.keys()).difference(set(best_categories.index))\nbest_categories\nfrom sklearn.preprocessing import MultiLabelBinarizer\n\nmlb = MultiLabelBinarizer()\ndf_cat_dummies = pd.DataFrame(mlb.fit_transform(df_reg.categories),columns=mlb.classes_, index=df_reg.index)\n\nif min_rows_categories > 0:\n    df_cat_dummies['category_others_categories'] = df_cat_dummies.apply(lambda x: x[list(others_categories)].sum(), axis=1)\n    df_cat_dummies = df_cat_dummies.drop(list(others_categories), axis=1)\n\n\ndf_reg = pd.concat([df_reg, df_cat_dummies], axis=1)\ndf_reg = df_reg.rename(columns={cat:'category_' + cat for cat in best_categories.index})\ndf_reg\ncategory_columns = [x for x in df_reg.columns if x.startswith('category_')]\ndf_reg[category_columns] = df_reg[category_columns].apply(lambda x: x.astype(float))\ndf_reg.to_parquet(product['data'])\n## Teste manual\nfrom IPython.display import display\nwith pd.option_context('display.max_rows', 5, 'display.max_columns', None): \n    display(df_reg.iloc[13]['categories'])\n    display(df_reg.iloc[[13]][category_columns])\n    display('----------------------------------')\n    display(df_reg.iloc[542]['categories'])\n    display(df_reg.iloc[[542]][category_columns])\n    display('----------------------------------')\n    display(df_reg.iloc[5389]['categories'])\n    display(df_reg.iloc[[5389]][category_columns])", "params": {"min_rows_categories": 50, "df_input_path": "../../dados/X_trainToronto.csv"}}